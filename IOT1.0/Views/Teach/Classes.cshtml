@using DataProvider.Models
@using DataProvider.Paging
@{
    ViewBag.Title = "班级维护";
}
@model ClassesListViewModel
@section styles{
    <style type="text/css">
        /*不写时钟还出不来。。。。*/
        .clockpicker-popover {
            z-index: 99999999;
        }
        .chosen-select {
            /*padding:0px;*/
        }
    </style>
}
<link href="~/Scripts/assets/css/plugins/clockpicker/clockpicker.css" rel="stylesheet" />
<div class="wrapper wrapper-content  animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <!-- 数据显示区 -->
                <div class="ibox-content">
                    <!-- 功能操作区 -->
                    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "frmQuery", @class = "form-horizontal" }))
                    {



                        <div class="form-group">
                            <div class="col-sm-2">
                                <label class="control-label">班级名称:</label>
                            </div>
                            <div class="col-sm-3">
                                @Html.TextBoxFor(t => t.search.ClassName, new { @class = "form-control input-sm", @type = "text", @placeholder = "请输入课程名称" })
                            </div>
                            <div class="col-sm-2">
                                <label class="control-label">课程名称:</label>
                            </div>
                            <div class="col-sm-3">


                                @Html.DropDownListFor(t => t.search.CourseID, Model.SourceIL1, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4" })

                            </div>

                        </div>





                        <div class="form-group">
                            <div class="col-sm-2">
                                <label class="control-label">开班时间:</label>
                            </div>


                            <div class="col-sm-3">
                                <div class="input-daterange input-group" id="datepicker">
                                    @Html.TextBoxFor(t => t.search.StartTime_start, new { @class = "input-sm form-control", @type = "text", @value = DateTime.Now })

                                    <span class="input-group-addon">到</span>
                                    @*<input type="text" class="input-sm form-control" name="end" value="2014-11-17">*@
                                    @Html.TextBoxFor(t => t.search.StartTime_end, new { @class = "input-sm form-control", @type = "text", @value = DateTime.Now })

                                </div>
                            </div>


                            <div class="col-sm-2">
                                <label class="control-label">结班时间:</label>
                            </div>


                            <div class="col-sm-3">
                                <div class="input-daterange input-group" id="datepicker1">
                                    @Html.TextBoxFor(t => t.search.EndTime_start, new { @class = "input-sm form-control", @type = "text", @value = DateTime.Now })
                                    @*<input type="text" class="input-sm form-control" name="start" value="2014-11-11">*@
                                    <span class="input-group-addon">到</span>
                                    @*<input type="text" class="input-sm form-control" name="end" value="2014-11-17">*@
                                    @Html.TextBoxFor(t => t.search.EndTime_end, new { @class = "input-sm form-control", @type = "text", @value = DateTime.Now })

                                </div>
                            </div>

                        </div>




                        <div class="form-group">
                            <div class="col-sm-2">
                                <label class="control-label">当前讲师:</label>
                            </div>
                            <div class="col-sm-3">

                                @Html.DropDownListFor(t => t.search.TeacherID, Model.SourceIL2, new { @class = "form-control input-sm chosen-selects", @style = "width:100%;height:100%;", @tabindex = "4" })

                            </div>
                          <div class="col-sm-2">
                                <label class="control-label">所属分校：</label>
                            </div>

                            <div class="col-sm-3">
                                @Html.DropDownListFor(t => t.search.ComCode,Model.search.ComCodeIL, new { @class = "input-sm form-control" ,@style = "width:100%;height:100%;", @tabindex = "4 "})
                            </div>

                        </div>


                        <div class="form-group">
                            <div class="col-sm-3">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-white btn-sm"><i class="fa fa-refresh"></i>刷新</button>

                                    <button class="btn btn-primary btn-sm" type="button" onclick="javascript:modify();"><i class="fa fa-plus-square"></i>新增</button>

                                </div>
                            </div>
                            <div class="col-sm-9 project-actions">
                                <button type="submit" class="btn btn-w-m btn-primary btn-sm">查&nbsp;&nbsp;&nbsp;&nbsp;询</button>
                            </div>
                        </div>



                    }
                    <!-- 数据列表 -->
                    <table class="table table-striped table-bordered table-hover dataTables-example">
                        <thead>
                            <tr>
                                <th>班级名称</th>
                                 <th>所属分校</th>
                                
                                <th>所属课程</th> 
                                <th>已上/总课时</th>
                                <th>已报/预招人数</th>
                                <th>授课方式</th>
                                <th>报名费用</th>
                                <th>开班时间</th>
                                <th>结班时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <!-- 循环数据 -->
                        <tbody>

                            @if (Model != null && Model.Classeslist.Count() > 0)
                            {
                                foreach (var m in Model.Classeslist)
                                {
                                    <tr>
                                        <td class="jz">@m.ClassName</td>
                                          <td>@m.CompName</td>
                                          
                                        <td>@m.CourseName</td>
                                        <td>@m.Lesson</td>
                                        <td>@m.Enroll</td>
                                        <td>@m.TeachTypeIDname</td>
                                        <td>@m.Expenses</td>
                                        <td>@m.StartTime</td>
                                        <td>@m.EndTime</td>
                                        <td>@m.StateIDname</td>
                                        <td>
                                            <a href="javascript:modify('@m.ID');" class="btn btn-primary btn-xs" type="button"><i class="fa fa-edit"></i>编辑</a>
                                            <a href="javascript:ClassList('@m.ID','@m.ClassName','@m.Enroll','@m.StateID','@m.TeachTypeID','@m.TotalLesson')" class="btn btn-primary btn-xs" type="button"><i class="fa fa-forward"></i>排课</a>
                                            <a href="javascript:adjust('@m.ID')" class="btn btn-primary btn-xs" type="button"><i class="fa fa-adjust"></i>分配</a>
                                            <a href="javascript:Upgrade('@m.ID')" class="btn btn-primary btn-xs" type="button"><i class="fa fa-level-up"></i>升班</a>
                                        </td>


                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="11" style="text-align: center; color: red;">未查询到数据,请更换查询条件试试!</td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @if (Model != null && Model.Classeslist.TotalPageCount > 0)
                    {
                        <div class="row">
                            <div class="dataTables_info col-xs-6">每页显示 @Model.search.PageSize 条，共<span>@Model.Classeslist.TotalItemCount</span>条数据</div>
                            <div class="col-xs-6">

                                @Html.Pager(Model.Classeslist, new PagerOptions(), "", new RouteValueDictionary {
                                   { "pageindex",  Model.search.CurrentPage },
                                   { "pagesize", ViewBag.PageSize },
                                   { "ClassName",  Model.search.ClassName },
                                   { "CourseID",  Model.search.CourseID },
                                   { "TeacherID",  Model.search.TeacherID },
                                   { "ComCode",  Model.search.ComCode }
                               }, null)
                            </div>

                        </div>
                    }

                </div>
            </div>
        </div>

    </div>
</div>







@*弹出层，班级编辑*@
<div class="ibox float-e-margins" id="buttoninfo" style="display: none">
    <div class="ibox-content">
        <form class="form-horizontal">
            <div class="form-group ">
                <label class="col-sm-3 control-label">班级名称：</label>
                <div class="col-sm-8">
                    <input type="text" placeholder="班级名称" class="form-control input-sm" id="ClassName">
                </div>
            </div>
            
                <div class="form-group ">
                <label class="col-sm-3 control-label ">所属分校 ：</label>
                <div class="col-sm-8">
                     @Html.DropDownListFor(t => t.search.ComCode, Model.ComCodeIL, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4" ,id="ComCode"})

                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-3 control-label">授课方式：</label>

                <div class="col-sm-8">

                    @Html.DropDownListFor(t => t.search.TeachTypeID, Model.SourceIL, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4", @id = "TeachTypeID" })

                </div>

            </div>

            <div class="form-group ">
                <label class="col-sm-3 control-label">课程名称 ：</label>
                <div class="col-sm-8">

                    @Html.DropDownListFor(t => t.search.CourseIDS, Model.SourceIL1, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4", @id = "CourseIDS" })

                </div>
            </div>

            <div class="form-group ">
                <label class="col-sm-3 control-label">当前讲师：</label>
                <div class="col-sm-8">
                    @Html.DropDownListFor(t => t.search.TeacherID, Model.SourceIL2, new { @class = "form-control input-sm chosen-selects", @style = "width:100%;height:100%;", @tabindex = "4", @id = "TeacherID" })
                </div>
            </div>

             <div class="form-group ">
                <label class="col-sm-3 control-label">当前讲师2：</label>
                <div class="col-sm-8">
                    @Html.DropDownListFor(t => t.search.Teacher2ID, Model.SourceIL2, new { @class = "form-control input-sm chosen-selects", @style = "width:100%;height:100%;", @tabindex = "4", @id = "Teacher2ID" })
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">教室：</label>
                <div class="col-sm-8">

                    @Html.DropDownListFor(t => t.search.RoomID, Model.SourceIL3, new { @class = "form-control input-sm chosen-select ", @style = "width:100%;height:100%;", @tabindex = "4", @id = "RoomID_Classes" })
                </div>
            </div>

            <div class="form-group ">
                <label class="col-sm-3 control-label">开班时间：</label>
                <div class="col-sm-8">
                    <div class="DateS input-group date">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        <input type="text" class="form-control input-sm" id="StartTime">
                    </div>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-3 control-label">结班时间：</label>
                <div class="col-sm-8">
                    <div class="DateS input-group date">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        <input type="text" class="form-control input-sm" id="EndTime">
                    </div>
                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-3 control-label">课时总数：</label>
                <div class="col-sm-8">
                    <input type="text" placeholder="请填写课时总数" class="form-control input-sm" id="TotalLesson">
                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-3 control-label">预招人数：</label>
                <div class="col-sm-8">
                    <input type="text" placeholder="请填写预招人数" class="form-control input-sm" id="PlanEnroll">
                </div>
            </div>
            <div class="form-group ">
                <label class="col-sm-3 control-label">报名费用：</label>
                <div class="col-sm-8">
                    <input type="text" placeholder="如果是试听班，可以填写零" class="form-control input-sm" id="Expenses">
                </div>
            </div>


        </form>
    </div>
</div>




@*弹出层，开班*@
<div class="ibox float-e-margins" id="ClassList" style="margin: 0px; display: none">
    <div class="ibox-content">
        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-3 control-label">班级名称：</label>
                <label class="col-sm-5 form-control-static" id="ClassName_generate"></label>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">报名学员数：</label>
                <label class="col-sm-5 form-control-static" id="Enroll_generate"></label>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">排课开始时间：</label>
                <div class="col-sm-5">
                    <div class="DateS input-group date">
                        <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        <input type="text" class="form-control input-sm" id="Start_Date">
                    </div>
                </div>
            </div>
            @*   <div class="form-group">
                    <label class="col-sm-3 control-label">排课结束时间：</label>
                    <div class="col-sm-5">
                        <div class="DateS input-group date">
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                            <input type="text" class="form-control input-sm" id="End_Date">
                        </div>
                    </div>
                </div>*@

            <div class="form-group ">
                <label class="col-sm-3 control-label">当前讲师：</label>
                <div class="col-sm-5">
                    @Html.DropDownListFor(t => t.search.TeacherID, Model.SourceIL2, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4", @id = "TeacherID_ClassList" })
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">教室：</label>
                <div class="col-sm-5">

                    @Html.DropDownListFor(t => t.search.RoomID, Model.SourceIL3, new { @class = "form-control input-sm chosen-select ", @style = "width:100%;height:100%;", @tabindex = "4", @id = "RoomID" })
                </div>
            </div>






            <div class="form-group">
                <label class="col-sm-3 control-label">时段：</label>
                <div class="col-sm-5">
                    @Html.DropDownListFor(t => t.search.TimePeriod, Model.SourceIL4, new { @class = "form-control input-sm chosen-select", @style = "width:100%;height:100%;", @tabindex = "4", @id = "TimePeriod" })
                </div>

                <div class="col-sm-2">
                    <a href="javascript:addTime()" class="btn btn-primary btn-sm" type="button"><i class="fa fa-adjust"></i>添加时段</a>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-3 control-label">课时总数：</label>
                <div class="col-sm-5">
                    <input type="text" readonly="true" class="form-control input-sm" id="TotalLesson_ClassList">
                </div>
            </div>


            <div class="form-group">
                <label class="col-sm-3 control-label">星期：</label>
                <div class="col-sm-9">
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Monday">星期一
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Tuesday">星期二
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Wednesday">星期三
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Thursday">星期四
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Friday">星期五
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Saturday">星期六
                    </label>
                    <label class="checkbox-inline i-checks">
                        <input type="checkbox" id="Sunday">星期日
                    </label>
                </div>
            </div>

        </form>
    </div>
</div>




@*弹出层，添加时段*@
<div class="ibox float-e-margins" id="addtime" style="margin: 0px; display: none">
    <div class="ibox-content">
        <form class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-3 control-label">开始时间：</label>
                <div class="col-sm-9">
                    <div class="input-group clockpicker" data-autoclose="true">
                        <input type="text" class="form-control" id="addtime_start">
                        <span class="input-group-addon">
                            <span class="fa fa-clock-o"></span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">结束时间：</label>
                <div class="col-sm-9">
                    <div class="input-group clockpicker" data-autoclose="true">
                        <input type="text" class="form-control" id="addtime_End">
                        <span class="input-group-addon">
                            <span class="fa fa-clock-o"></span>
                        </span>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>




@*弹出层，分配学员*@
<div class="ibox float-e-margins" id="adjust" style="margin: 0px; display: none">
    <div class="ibox-content">
        <form class=" form-horizontal">
            <div class="form-group">
                <div class="col-sm-2">
                    <label class="control-label">姓名:</label>
                </div>
                <div class="col-sm-4">
                    <input type="text" placeholder="请输入姓名" class="form-control input-sm" id="Enroll_Name">
                </div>
                <div class="col-sm-2">
                    <label class="control-label">学号:</label>
                </div>
                <div class="col-sm-4">

                    <input type="text" placeholder="请输入学号" class="form-control input-sm" id="Enroll_StudentID">
                </div>
            </div>
            <div class="form-group">
                <div class="project-actions">
                    <button type="button" class="btn btn-w-m btn-primary btn-sm" onclick="QueryEnroll_list()">查&nbsp;&nbsp;&nbsp;&nbsp;询</button>

                    <input type="text" class="form-control input-sm" id="ClassID" style="display: none">
                </div>
            </div>
            <div class="m-t-md">
                <!-- m=marging ,t=top ,md=20px -->
                <div class="">
                    <table class="table table-striped table-bordered table-hover dataTables-example" id="Enroll_list"></table>

                </div>
            </div>
        </form>
    </div>
</div>
@*分配学员中的二级弹出层，转班*@
<div class="ibox float-e-margins" id="transfer" style="margin: 0px; display: none">
    <div class="ibox-content">
        <form class=" form-inline">
            <div class="form-group">
                <div class="col-sm-3">
                    <label class="control-label">班级名称:</label>
                </div>
                <div class="col-sm-6">
                    <input type="text" placeholder="请班级名称" class="form-control input-sm" id="transfe_ClassName">
                </div>
            </div>
            <div class="form-group">
                <div class="project-actions">
                    <button type="button" class="btn btn-w-m btn-primary btn-sm" onclick="Class_transfe_list()">查&nbsp;&nbsp;&nbsp;&nbsp;询</button>

                    <input type="text" class="form-control input-sm" id="transfe_Enroll_ID" style="display:none">
                    <input type="text" class="form-control input-sm" id="transfe_StudentID" style="display:none">
                    <input type="text" class="form-control input-sm" id="Enroll_ClassID" style="display:none">
                </div>
            </div>
            <div class="m-t-md">
                <!-- m=marging ,t=top ,md=20px -->
                <div class="">
                    <table class="table table-striped table-bordered table-hover dataTables-example" id="Class_transfe"></table>
                </div>
            </div>
        </form>
    </div>
</div>

@*升班*@
<div class="ibox float-e-margins" id="upgrade" style="margin: 0px; display: none">
    <div class="ibox-content">
        <form class=" form-horizontal">
            <input type="text" placeholder="班级ID号" class="form-control input-sm" id="ClassID_UP" style="display:none">
            <div class="m-t-md">
                <!-- m=marging ,t=top ,md=20px -->
                <div class="">
                    <table class="table table-striped table-bordered table-hover dataTables-example" id="Enroll_listup"></table>
                </div>
            </div>
            <div class="form-group">
                <div class="project-actions m-r-md">
                    <div class="col-sm-6">
                        <label class="control-label">请选择您要升级到的班级信息：</label>
                    </div>
                    <div class="col-sm-6">
                        @Html.DropDownListFor(t => t.UpgradeClassID, Model.UpgradeClassesIL, new { @class = "form-control", @id = "UpgradeClass" })
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>










@*用bootstrap-table需要引入*@
<script src="~/Scripts/assets/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
<script src="~/Scripts/assets/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="~/Scripts/assets/js/plugins/clockpicker/clockpicker.js"></script>
<script type="text/javascript">

    //判断页面是否有回车操作
    window.document.onkeydown = function (e) {
        e = e || window.event;
        if (e.keyCode == 13 || e.keyCode == 108) {
            document.getElementById('frmQuery').submit();
        }
    }
    //点击列表的编辑按钮，编辑操作
    function modify(id) {
        cleanData("buttoninfo");
        layer.open({
            type: 1,
            title: "<h5 class='ibox-title'>编辑</h3>",
            area: ['680px', '490px'],
            content: $('#buttoninfo'),
            btn: ['保存', '取消'],
            yes: function () {
                save(id);
            },
            cancel: function (index) {
                layer.close(index);
            }
        });

        //配置下拉控件chosen
        $(".chosen-selects").chosen({
            no_results_text: "未找到此选项!",
            search_contains: true,
            width: '100%'
        });


        if (id) {//提供存着ID就是修改，则加载数据，不然打开空页面
            var loadindex = layer.load();
            loaddetail(id, loadindex)
        }

        //激活日期控件
        $('.DateS').datepicker({
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true
        });
      
    }



    //排课弹窗
    function ClassList(id, ClassName, Enroll, StateID, TeachTypeID, TotalLesson) {
        if (StateID != 1) {
            layer.msg("已排课,不能重复排课！");
            return false;
        }
        if (TeachTypeID == 1) {
            layer.msg("试听班,不能排课！");
            return false;
        }
        cleanData("ClassList");
        $("#ClassName_generate").html(ClassName);
        $("#Enroll_generate").html(Enroll);
        $("#TotalLesson_ClassList").val(TotalLesson);
        layer.open({
            type: 1,
            title: "<h5 class='ibox-title'>排课</h3>",
            area: ['800px', '500px'],
            content: $('#ClassList'),
            btn: ['保存', '取消'],
            yes: function () {
                ClassListSave(id);
            },
            cancel: function (index) {
                layer.close(index);
            }
        });
        //激活日期控件
        $('.DateS').datepicker({
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true
        });

    }

    //加时段弹窗
    function addTime() {
        cleanData("addtime");//清空数据
        layer.open({
            type: 1,
            title: "<h5 class='ibox-title'>添加时段</h3>",
            area: ['400px', '200px'],
            content: $('#addtime'),
            btn: ['保存', '取消'],
            yes: function () {
                addTime_save();
            },
            cancel: function (index) {
                layer.close(index);
            }
        });

        //激活时钟控件
        $('.clockpicker').clockpicker();
    }

    //分配学员，也就是转班弹出功能
    function adjust(id) {
        cleanData("adjust");//清空数据
        $('#ClassID').val(id);
        layer.open({
            type: 1,
            title: "<h3 class='ibox-title'>分配学员</h3>",
            area: ['800px', '500px'],
            content: $('#adjust'),
            // btn: ['保存', '取消'],
            yes: function () {
                //  save(id);
            },
            cancel: function (index) {
                layer.close(index);
            }
        });
        $('#Enroll_list').bootstrapTable('refresh');
    }


    //分配学员弹出页面查询
    function QueryEnroll_list() {
        //重新刷新
        $('#Enroll_list').bootstrapTable('refresh');

    }



    function loaddetail(id, loadindex) {
        $.ajax({
            url: '@Url.Action("GetClassesByID", "Teach")',
            type: "post",
            data: { id: id },
            success: function (json) {
                if (json.status == 200) {//成功

                    $("#ComCode").val(json.data.ComCode);
                    $("#ClassName").val(json.data.ClassName);
                    $("#TeachTypeID").val(json.data.TeachTypeID);
                    $("#CourseIDS").val(json.data.CourseID);
                    $("#TeacherID").val(json.data.TeacherID);
                    $("#Teacher2ID").val(json.data.Teacher2ID);
                    $("#RoomID_Classes").val(json.data.RoomID);
                    $("#StartTime").val(ChangeDateFormat(json.data.StartTime));
                    $("#EndTime").val(ChangeDateFormat(json.data.EndTime));
                    $("#TotalLesson").val(json.data.TotalLesson);
                    $("#PlanEnroll").val(json.data.PlanEnroll);
                    $("#Expenses").val(json.data.Expenses);
                    layer.close(loadindex);//关闭加载层
                    $(".chosen-selects").trigger("chosen:updated");
                }
            },
            error: function (xmLHttpRequest, textStatus, errorThrown) {
                layer.msg("系统异常，请重试<br/>错误信息：" + xmLHttpRequest.responseText);
            }
        });
    }
    //升班弹出页面
    function Upgrade(classid) {
        cleanData("upgrade");//清空数据
        $("#ClassID_UP").val(classid);//把班级号赋值到空间，方便之后取值
        layer.open({
            type: 1,
            title: "<h3 class='ibox-title'>班级学员</h3>",
            area: ['800px', '500px'],
            content: $('#upgrade'),
            btn: ['确定', '取消'],
            yes: function () {
                layer.confirm('是否已仔细核对过您填写的信息，确认进行升班?', { icon: 3, title: '提示' }, function (index) {
                   

                    layer.close(index);
                    var oldclassid = $("#ClassID_UP").val();   //旧的班级ID
                    var newclassid = $("#UpgradeClass").val();//新的班级ID
                    var upgradedata = [];//需要提交升班学员数据
                    $("#Enroll_listup tbody").find("tr").each(function (ai, am) {//遍历需要升班的学员列表

                        var enid = $(this).find("td").eq(0).text();//取到的报名ID
                        var newclasshour = $(this).find("td").eq(6).children('input').val();;//用户填写的转换后的课时
                        var upprice = $(this).find("td").eq(7).children('input').val();;//用户填写的差价
                        upgradedata.push({
                            "enid": enid,
                            "newclasshour": newclasshour,
                            "upprice": upprice
                        })
                    });

                    $.post('@Url.Action("UpgradeClass", "Teach")', {
                        oldclassid: oldclassid,
                        newclassid: newclassid,
                        did: JSON.stringify(upgradedata)
                    },
                    function (json) {
                        setTimeout(function () {
                            window.location.reload(); //刷新
                        }, 3000);

                        layer.closeAll();
                        layer.msg(json.msg);
                    }, 'json');
                });
          
  
            },
            cancel: function (index) {
                layer.close(index);
            }
        });
        $('#Enroll_listup').bootstrapTable('refresh');
    }

    //保存或者新增
    function save(id) {
        var obj = new Object;
        if (id) {//有ID就是修改模式，没有就是新增模式
            obj.ID = id;
        }
     
        obj.ClassName = $("#ClassName").val().trim();
        if (!obj.ClassName) {
            layer.msg("请输入班级名称！");
            return false;
        }
        obj.ComCode = $("#ComCode").val().trim();
        if (!obj.ComCode) {
            layer.msg("请选择所属分校！");
            return false;
        }
        obj.TeachTypeID = $("#TeachTypeID").val().trim();//赋值必须和数据库字段对应
        if (!obj.TeachTypeID) {
            layer.msg("请选择授课方式！");
            return false;
        }

        obj.CourseID = $("#CourseIDS").val().trim();
        if (!obj.CourseID) {
            layer.msg("请选择所属课程！");
            return false;
        }

        obj.TeacherID = $("#TeacherID").val().trim();
        //if (!obj.TeacherID) {
        //    layer.msg("请选择当前讲师！");
        //    return false;
        //}
        obj.Teacher2ID = $("#Teacher2ID").val().trim();
        obj.RoomID = $("#RoomID_Classes").val().trim();
        //if (!obj.RoomID) {
        //    layer.msg("请选择当前教室！");
        //    return false;
        //}

        obj.StartTime = $("#StartTime").val().trim();
        if (!obj.StartTime) {
            layer.msg("请选择开班时间！");
            return false;
        }

        obj.EndTime = $("#EndTime").val().trim();
        //if (!obj.EndTime) {
        //    layer.msg("请选择结班时间！");
        //    return false;
        //}

        obj.TotalLesson = $("#TotalLesson").val().trim();
        if (!obj.TotalLesson) {
            layer.msg("请输入课时总数！");
            return false;
        }

        obj.PlanEnroll = $("#PlanEnroll").val().trim();
        if (!obj.PlanEnroll) {
            layer.msg("请输入预招人数！");
            return false;
        }
        obj.Expenses = $("#Expenses").val().trim();
        var reg = /^[1-9]\d*$/;//正整数
        if (!reg.test(obj.Expenses)) {
            layer.msg("报名费用必须是正整数！");
            return false;
        }
        var action = '';
        if (id) {//有ID就是修改模式，没有就是新增模式
            action = '@Url.Action("SaveClasses", "Teach")';
        }
        else { action = '@Url.Action("AddClasses", "Teach")' }
        $.post(action, {
            "data": JSON.stringify(obj)//序列化对象
        }, function (json) {
            if (json.status == 200) {//成功

                layer.msg(json.msg);//弹出服务器返回的消息
                setTimeout(function () {//操作
                    layer.closeAll();//关闭所有层
                    window.location.reload(); //刷新
                }, 3000);
            }
        }, 'json');
    }



    //课程表保存
    function ClassListSave(id) {
        var obj = new Object;

        obj.ClassID = id;  //班级


        obj.Start_Date = $("#Start_Date").val().trim();
        if (!obj.Start_Date) {
            layer.msg("请选择排课开始时间！");
            return false;
        }
        //obj.End_Date = $("#End_Date").val().trim();//赋值必须和数据库字段对应
        //if (!obj.End_Date) {
        //    layer.msg("请选择排课结束时间！");
        //    return false;
        //}

        obj.TeacherID = $("#TeacherID_ClassList").val().trim();
        if (!obj.TeacherID) {
            layer.msg("请选择当前讲师！");
            return false;
        }

        obj.RoomID = $("#RoomID").val().trim();
        if (!obj.RoomID) {
            layer.msg("请选择当前教室！");
            return false;
        }


        obj.TotalLesson = $("#TotalLesson_ClassList").val().trim();
        if (!obj.TotalLesson) {
            layer.msg("请输入课时总数！");
            return false;
        }

        obj.TimePeriod = $("#TimePeriod").val().trim();
        if (!obj.TimePeriod) {
            layer.msg("请选择时段！");
            return false;
        }

        if (obj.Start_Date > obj.End_Date) {
            layer.msg("开始时间不能大于结束时间");
            return false;
        }
        var canpass = 0;//没有选中星期
        if ($("#Monday").is(':checked')) {//判断停用按钮是否选中
            obj.Monday = 1; //星期一
            canpass = 1;
        }
        if ($("#Tuesday").is(':checked')) {//判断停用按钮是否选中
            obj.Tuesday = 2;
            canpass = 1;
        }
        if ($("#Wednesday").is(':checked')) {//判断停用按钮是否选中
            obj.Wednesday = 3;
            canpass = 1;
        }
        if ($("#Thursday").is(':checked')) {//判断停用按钮是否选中
            obj.Thursday = 4;
            canpass = 1;
        }
        if ($("#Friday").is(':checked')) {//判断停用按钮是否选中
            obj.Friday = 5;
            canpass = 1;
        }
        if ($("#Saturday").is(':checked')) {//判断停用按钮是否选中
            obj.Saturday = 6;
            canpass = 1;
        }
        if ($("#Sunday").is(':checked')) {//判断停用按钮是否选中
            obj.Sunday = 0; //因为c#后台获取到星期天是0
            canpass = 1;
        }
        if (canpass == 0) {
            layer.msg("请至少沟选一个星期！");
            return false;
        }

        // 排课只有新增
        var action = '@Url.Action("ClassListSave", "Teach")';


        $.post(action, {
            "data": JSON.stringify(obj)//序列化对象
        }, function (json) {
            if (json.status == 200) {//成功

                layer.msg(json.msg);//弹出服务器返回的消息
                setTimeout(function () {//操作
                    layer.closeAll();//关闭所有层
                    window.location.reload(); //刷新
                }, 3000);
            }
        }, 'json');
    }





    //时钟表保存（字典表）
    function addTime_save(id) {
        var obj = new Object;

        obj.addtime_start = $("#addtime_start").val().trim();
        if (!obj.addtime_start) {
            layer.msg("请选择开始时间！");
            return false;
        }
        obj.addtime_End = $("#addtime_End").val().trim();//赋值必须和数据库字段对应
        if (!obj.addtime_End) {
            layer.msg("请选择结束时间！");
            return false;
        }

        if (obj.addtime_start > obj.addtime_End) {
            layer.msg("开始时间不能大于结束时间");
            return false;
        }

        // 时钟只有新增
        var action = '@Url.Action("addTime_save", "Teach")';


        $.post(action, {
            "data": JSON.stringify(obj)//序列化对象
        }, function (json) {
            if (json.status == 200) {//成功

                layer.msg(json.msg);//弹出服务器返回的消息
                json = JSON.parse(json.data); //必须要把前台的值序列化，不然获取不到。

                $("#TimePeriod").append("<option value='" + json["DicItemID"] + "'>" + json["DicItemName"] + "</option>");


            }
        }, 'json');
    }


    //分配中的转班弹出层
    function transfer() {
        // cleanData("transfer");//清空数据
        layer.open({
            type: 1,
            title: "<h3 class='ibox-title'>分配学员</h3>",
            area: ['750px', '500px'],
            content: $('#transfer'),
            btn: ['取消'],
            cancel: function (index) {
                layer.close(index);
            }
        });
    }

    //#region 注册试听事件

    window.operateEvents = {
        'click .RoleOfA': function (e, value, row, index) {

            transfer();
            $('#transfe_Enroll_ID').val(row.ID);
            $('#transfe_StudentID').val(row.StudentID);
            $('#Enroll_ClassID').val(row.ClassID);
            $('#Class_transfe').bootstrapTable('refresh');

        }

    };
    //#endregion
    window.operateEvents_transfe = {
        'click .Class_transfe': function (e, value, row, index) {
            $.post('@Url.Action("SaveClass_transfe", "Teach")', {
                "Classes_ID": row.ID,//序列化对象
                "Enroll_ID": $('#transfe_Enroll_ID').val().trim(),
                "Enroll_StudentID": $('#transfe_StudentID').val().trim(),
                "Enroll_ClassID": $('#Enroll_ClassID').val().trim(),

            }, function (json) {
                if (json.status == 200) {//成功

                    layer.msg(json.msg);//弹出服务器返回的消息
                    //重新刷新
                    $('#Class_transfe').bootstrapTable('refresh');
                    $('#Enroll_list').bootstrapTable('refresh');
                    setTimeout(function () {
                        window.location.reload(); //刷新
                    }, 3000);



                }
            }, 'json');

        }
    };


    //-------------分配学员----------------------------------------------------------
    //分配学员
    $('#Enroll_list').bootstrapTable({
        method: 'POST',
        dataType: 'json',
        contentType: "application/x-www-form-urlencoded",
        cache: false,
        striped: true,                              //是否显示行间隔色
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        url: '@Url.Content("~/Teach/GetClassesByClassID")',
        showColumns: false,
        pagination: false,
        queryParams: queryParams,
        columns: [

             {
                 field: 'StudentID',
                 title: '学号',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'Name',
                 title: '姓名',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'BindPhone',
                 title: '联系方式',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             },
              {
                  field: 'CreateTime',
                  title: '报名日期',
                  align: 'center',
                  valign: 'middle',
                  formatter: function (value, row, index) {//用于格式化数据
                      return ChangeDateFormat(value);//调用模板页的通用方法格式化时间
                  }
              }, {
                  field: 'ClassName',
                  title: '班级名称',
                  align: 'center',
                  valign: 'middle',
                  sortable: true
              }
              , {
                  field: 'operate',
                  title: '操作',
                  align: 'center',
                  events: operateEvents,
                  formatter: operateFormatter
              }

        ]
    });
    //查询参数
    function queryParams(params) {

        return {

            pageSize: 1,

            pageIndex: 1,
            ClassID: $("#ClassID").val().trim(),
            Enroll_Name: $("#Enroll_Name").val().trim(),
            Enroll_StudentID: $("#Enroll_StudentID").val().trim(),
        };

    }
    //按钮事件
    function operateFormatter(value, row, index) {
        return [
            '<button type="button" class="RoleOfA btn btn-primary btn-xs"">转班</button>'
        ].join('');
    }




    function Class_transfe_list() {
        //重新刷新
        $('#Class_transfe').bootstrapTable('refresh');
    }



    //-------------分配学员转班页面----------------------------------------------------------
    //分配学员转班页面
    $('#Class_transfe').bootstrapTable({
        method: 'POST',
        dataType: 'json',
        contentType: "application/x-www-form-urlencoded",
        cache: false,
        striped: true,                              //是否显示行间隔色
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        url: '@Url.Content("~/Teach/GeClass_transfe_List")',
        showColumns: false,
        pagination: false,
        queryParams: queryParams_transfe,
        columns: [

             {
                 field: 'ClassName',
                 title: '班级名称',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'CourseName',
                 title: '所属课程',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'Lesson',
                 title: '已上/总课时',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             },
              {
                  field: 'Enroll',
                  title: '已报/预招人数',
                  align: 'center',
                  valign: 'middle',
                  sortable: true
              },
               {
                   field: 'RoomIDname',
                   title: '教室',
                   align: 'center',
                   valign: 'middle',
                   sortable: true
               },
                {
                    field: 'name',
                    title: '当前讲师',
                    align: 'center',
                    valign: 'middle',
                    sortable: true
                },
                 {
                     field: 'StartTime',
                     title: '开班时间',
                     align: 'center',
                     valign: 'middle',
                     formatter: function (value, row, index) {//用于格式化数据
                         return ChangeDateFormat(value);//调用模板页的通用方法格式化时间
                     }
                 },
              {
                  field: 'EndTime',
                  title: '结班时间',
                  align: 'center',
                  valign: 'middle',
                  formatter: function (value, row, index) {//用于格式化数据
                      return ChangeDateFormat(value);//调用模板页的通用方法格式化时间
                  }
              }, {
                  field: 'StateIDname',
                  title: '状态',
                  align: 'center',
                  valign: 'middle',
                  sortable: true
              }
              , {
                  field: 'operate',
                  title: '操作',
                  align: 'center',
                  events: operateEvents_transfe,
                  formatter: operateFormatter_transfe
              }

        ]
    });
    //查询参数
    function queryParams_transfe(params) {

        return {

            pageSize: 1,

            pageIndex: 1,
            ClassName: $("#transfe_ClassName").val().trim()

        };

    }
    //按钮事件
    function operateFormatter_transfe(value, row, index) {
        return [
            '<button type="button" class="Class_transfe btn btn-primary btn-xs"">安排</button>'
        ].join('');
    }


    function Class_transfe_list() {
        //重新刷新
        $('#Class_transfe').bootstrapTable('refresh');
    }





    //-------------班级升班----------------------------------------------------------
    $('#Enroll_listup').bootstrapTable({
        method: 'POST',
        dataType: 'json',
        contentType: "application/x-www-form-urlencoded",
        cache: false,
        striped: true,                              //是否显示行间隔色
        sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
        url: '@Url.Content("~/Teach/GetClassesByClassID")',
        showColumns: false,
        pagination: false,
        queryParams: queryParams_UP,//查询参数
        columns: [

             {
                 field: 'ID',
                 title: '报名ID',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'Name',
                 title: '姓名',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             }, {
                 field: 'BindPhone',
                 title: '联系方式',
                 align: 'center',
                 valign: 'middle',
                 sortable: true
             },
              {
                  field: 'CreateTime',
                  title: '报名日期',
                  align: 'center',
                  valign: 'middle',
                  formatter: function (value, row, index) {//用于格式化数据
                      return ChangeDateFormat(value);//调用模板页的通用方法格式化时间
                  }
              }, {
                  field: 'ClassName',
                  title: '原班级名称',
                  align: 'center',
                  valign: 'middle',
                  sortable: true
              }
              , {
                  field: 'RemainClassHour',
                  title: '原剩余课时',
                  align: 'center',
                  valign: 'middle',
                  sortable: true
              }
              , {
                  field: '',
                  title: '升班后课时',
                  align: 'center',
                  formatter: editcol_Upgrade
              }
              , {
                  field: '',
                  title: '补收差价',
                  align: 'center',
                  formatter: editcol_Upgrade_difference
              }
        ]
    });
    //升班查询参数
    function queryParams_UP(params) {
        return {
            ClassID: $("#ClassID_UP").val().trim()
        };
    }
    //升班字段文本框
    function editcol_Upgrade(value, row, index) {
        return [
            '<input name="txtUpgrade" type="text" value="0" class="input-sm form-control" style="width:50px">'
        ].join('');
    }
    //升班补差价
    function editcol_Upgrade_difference(value, row, index) {
        return [
            '<input name="Upgrade_difference" type="text" value="0" class="input-sm form-control" style="width:50px">'
        ].join('');
    }

    //时间比较方法
    function ComparDate(v1, v2) {
        var d1 = new Date(v1().replace("/\-/g", "\/"));//获取开始时间
        var d2 = new Date(v2().replace("/\-/g", "\/"));//获取结束时间

        if (d1 > d2) {
            alert("开始时间不能大于结束时间");
            return false;
        }
        else {
            return true;
        }
    }


    function exportForm() {
        var $frm = $('#exportform');
        var array = $('#frmQuery').serializeArray();

        for (i = 0, length = array.length; i < length; i) {
            key = array[i].name;
            value = array[i].value;
            $frm.append($('<input name = "' + key + '" value = "' + value + '"  style="display:none"/>'));
        }

        $frm.submit();
    }
</script>
